{% extends "base.html" %}

{% block title %}{{ game_name }} - Game Server Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Games</a></li>
                <li class="breadcrumb-item active">{{ game_name }}</li>
            </ol>
        </nav>
        <h1>{{ game_name }}</h1>
        <p class="lead">Game server instances and components</p>
    </div>
</div>

{% if instances %}
{% for instance in instances %}
<div class="card mb-4">
    <div class="card-header">
        <h4>Instance: {{ instance.name }}</h4>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>Namespace</th>
                        <th>Replicas</th>
                        <th>Status</th>
                        <th>Resources</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for component in instance.components %}
                    <tr>
                        <td>{{ component.component }}</td>
                        <td>{{ component.namespace }}</td>
                        <td>
                            <span class="text-muted">{{ component.available_replicas or 0 }}/{{ component.replicas }}</span>
                            {% if component.replicas > 0 and component.available_replicas == 0 %}
                            <span class="ms-2 badge bg-danger">Failed</span>
                            {% elif component.replicas > 0 and component.available_replicas < component.replicas %}
                            <span class="ms-2 badge bg-warning">Scaling</span>
                            {% elif component.replicas == 0 %}
                            <span class="ms-2 badge bg-secondary">Stopped</span>
                            {% else %}
                            <span class="ms-2 badge bg-success">Ready</span>
                            {% endif %}
                        </td>
                        <td>
                            <div>
                                {% if component.status == "active" %}
                                <span class="badge bg-success">Active</span>
                                {% else %}
                                <span class="badge bg-danger">Failed</span>
                                {% endif %}
                            </div>
                            {% if component.conditions %}
                            <div class="conditions-container">
                                <button class="btn btn-sm btn-link p-0 mt-1" 
                                        type="button" 
                                        data-bs-toggle="collapse" 
                                        data-bs-target="#conditions-{{ component.namespace }}-{{ component.name }}" 
                                        aria-expanded="false">
                                    View conditions
                                </button>
                                <div class="collapse mt-2 conditions-collapse" id="conditions-{{ component.namespace }}-{{ component.name }}">
                                    <div class="card card-body p-3">
                                        <div class="conditions-header">
                                            <h6>{{ component.component }} Conditions</h6>
                                            <button type="button" class="conditions-close" 
                                                    data-bs-toggle="collapse" 
                                                    data-bs-target="#conditions-{{ component.namespace }}-{{ component.name }}" 
                                                    aria-label="Close">Ã—</button>
                                        </div>
                                        <ul class="list-unstyled mb-0 small">
                                        {% for condition in component.conditions %}
                                            <li class="mb-2">
                                                <div><strong>{{ condition.type }}</strong>: {{ condition.status }}</div>
                                                {% if condition.message %}
                                                <div class="text-muted">{{ condition.message }}</div>
                                                {% endif %}
                                            </li>
                                        {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </td>
                        <td>
                            <div class="resource-usage">
                                <span title="CPU Usage" class="resource-item">
                                    <i class="bi bi-cpu"></i> {{ component.cpu_usage or 'N/A' }}
                                </span>
                                <br>
                                <span title="Memory Usage" class="resource-item">
                                    <i class="bi bi-memory"></i> {{ component.memory_usage or 'N/A' }}
                                </span>
                            </div>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-success start-deployment" 
                                        data-namespace="{{ component.namespace }}" 
                                        data-name="{{ component.name }}"
                                        title="Start"
                                        {% if component.replicas > 0 %}disabled{% endif %}>
                                    <i class="bi bi-play-fill"></i>
                                </button>
                                <button class="btn btn-sm btn-primary restart-deployment" 
                                        data-namespace="{{ component.namespace }}" 
                                        data-name="{{ component.name }}"
                                        title="Restart"
                                        {% if component.replicas == 0 %}disabled{% endif %}>
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                                <button class="btn btn-sm btn-danger stop-deployment" 
                                        data-namespace="{{ component.namespace }}" 
                                        data-name="{{ component.name }}"
                                        title="Stop"
                                        {% if component.replicas == 0 %}disabled{% endif %}>
                                    <i class="bi bi-stop-fill"></i>
                                </button>
                                <button class="btn btn-sm btn-secondary view-logs" 
                                        data-namespace="{{ component.namespace }}" 
                                        data-name="{{ component.name }}"
                                        data-bs-toggle="modal"
                                        data-bs-target="#logsModal"
                                        title="View Logs"
                                        {% if component.replicas == 0 %}disabled{% endif %}>
                                    <i class="bi bi-terminal"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endfor %}
{% else %}
<div class="alert alert-info">
    <h4 class="alert-heading">No instances found for {{ game_name }}!</h4>
    <p>No deployments with game-server/game={{ game_name }} annotation were found.</p>
</div>
{% endif %}
<!-- Logs Modal -->
<div class="modal fade" id="logsModal" tabindex="-1" aria-labelledby="logsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logsModalLabel">Container Logs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <select id="podSelector" class="form-select">
                        <option selected>Loading pods...</option>
                    </select>
                </div>
                <div class="logs-container">
                    <pre id="logsContent" class="logs">Loading logs...</pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="refreshLogs">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle condition buttons
    document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-bs-target');
            const targetElement = document.querySelector(targetId);
            
            // Position the popup near the button that was clicked
            if (targetElement) {
                // Get button position
                const rect = this.getBoundingClientRect();
                const popupTop = rect.bottom + window.scrollY + 5; // 5px below the button
                const popupLeft = rect.left + window.scrollX;
                
                // Set the position
                targetElement.style.top = popupTop + 'px';
                targetElement.style.left = popupLeft + 'px';
            }
        });
    });

    // Handle start buttons
    document.querySelectorAll('.start-deployment').forEach(button => {
        button.addEventListener('click', async function() {
            const namespace = this.getAttribute('data-namespace');
            const name = this.getAttribute('data-name');
            
            if (!confirm(`Are you sure you want to start the deployment ${namespace}/${name}?`)) {
                return;
            }
            
            this.disabled = true;
            const originalContent = this.innerHTML;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            
            try {
                const response = await fetch(`/api/deployments/${namespace}/${name}/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Deployment start initiated successfully!');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    alert(`Error: ${result.detail || 'Unknown error'}`);
                    this.disabled = false;
                    this.innerHTML = originalContent;
                }
            } catch (error) {
                alert(`Failed to start deployment: ${error.message}`);
                this.disabled = false;
                this.innerHTML = originalContent;
            }
        });
    });

    // Handle restart buttons
    document.querySelectorAll('.restart-deployment').forEach(button => {
        button.addEventListener('click', async function() {
            const namespace = this.getAttribute('data-namespace');
            const name = this.getAttribute('data-name');
            
            if (!confirm(`Are you sure you want to restart the deployment ${namespace}/${name}?`)) {
                return;
            }
            
            this.disabled = true;
            const originalContent = this.innerHTML;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            
            try {
                const response = await fetch(`/api/deployments/${namespace}/${name}/restart`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Deployment restart initiated successfully!');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    alert(`Error: ${result.detail || 'Unknown error'}`);
                    this.disabled = false;
                    this.innerHTML = originalContent;
                }
            } catch (error) {
                alert(`Failed to restart deployment: ${error.message}`);
                this.disabled = false;
                this.innerHTML = originalContent;
            }
        });
    });

    // Handle stop buttons
    document.querySelectorAll('.stop-deployment').forEach(button => {
        button.addEventListener('click', async function() {
            const namespace = this.getAttribute('data-namespace');
            const name = this.getAttribute('data-name');
            
            if (!confirm(`Are you sure you want to stop the deployment ${namespace}/${name}?`)) {
                return;
            }
            
            this.disabled = true;
            const originalContent = this.innerHTML;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            
            try {
                const response = await fetch(`/api/deployments/${namespace}/${name}/stop`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Deployment stop initiated successfully!');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    alert(`Error: ${result.detail || 'Unknown error'}`);
                    this.disabled = false;
                    this.innerHTML = originalContent;
                }
            } catch (error) {
                alert(`Failed to stop deployment: ${error.message}`);
                this.disabled = false;
                this.innerHTML = originalContent;
            }
        });
    });
    
    // Logs modal handling
    const logsModal = document.getElementById('logsModal');
    const podSelector = document.getElementById('podSelector');
    const logsContent = document.getElementById('logsContent');
    const refreshLogsButton = document.getElementById('refreshLogs');
    
    let currentNamespace = null;
    let currentDeployment = null;
    let currentPod = null;
    
    // Handle view logs button clicks
    document.querySelectorAll('.view-logs').forEach(button => {
        button.addEventListener('click', function() {
            currentNamespace = this.getAttribute('data-namespace');
            currentDeployment = this.getAttribute('data-name');
            
            // Update modal title
            document.getElementById('logsModalLabel').textContent = 
                `Logs: ${currentDeployment} (${currentNamespace})`;
            
            // Reset pod selector and logs content
            podSelector.innerHTML = '<option selected>Loading pods...</option>';
            logsContent.textContent = 'Loading pods...';
            
            // Fetch pods for this deployment
            fetchPods(currentNamespace, currentDeployment);
        });
    });
    
    // Handle pod selection change
    podSelector.addEventListener('change', function() {
        if (this.value) {
            currentPod = this.value;
            fetchLogs(currentNamespace, currentPod);
        }
    });
    
    // Handle refresh logs button
    refreshLogsButton.addEventListener('click', function() {
        if (currentNamespace && currentPod) {
            fetchLogs(currentNamespace, currentPod);
        }
    });
    
    // Function to fetch pods for a deployment
    async function fetchPods(namespace, deployment) {
        try {
            const response = await fetch(`/api/deployments/${namespace}/${deployment}/pods`);
            
            if (!response.ok) {
                throw new Error('Failed to fetch pods');
            }
            
            const pods = await response.json();
            
            // Clear pod selector
            podSelector.innerHTML = '';
            
            if (pods.length === 0) {
                podSelector.innerHTML = '<option>No pods found</option>';
                logsContent.textContent = 'No pods found for this deployment.';
                return;
            }
            
            // Add pods to selector
            pods.forEach(pod => {
                const option = document.createElement('option');
                option.value = pod.name;
                option.textContent = `${pod.name} (${pod.status})`;
                podSelector.appendChild(option);
            });
            
            // Select the first pod and fetch its logs
            currentPod = pods[0].name;
            fetchLogs(namespace, currentPod);
            
        } catch (error) {
            console.error('Error fetching pods:', error);
            podSelector.innerHTML = '<option>Failed to load pods</option>';
            logsContent.textContent = `Error: ${error.message}`;
        }
    }
    
    // Function to fetch logs for a pod
    async function fetchLogs(namespace, podName) {
        logsContent.textContent = 'Loading logs...';
        
        try {
            const response = await fetch(`/api/pods/${namespace}/${podName}/logs?tail_lines=200`);
            
            if (!response.ok) {
                throw new Error('Failed to fetch logs');
            }
            
            const data = await response.json();
            
            // Display logs
            if (data.logs && data.logs.trim()) {
                logsContent.textContent = data.logs;
            } else {
                logsContent.textContent = 'No logs available.';
            }
            
            // Scroll to bottom of logs
            const logsContainer = document.querySelector('.logs-container');
            logsContainer.scrollTop = logsContainer.scrollHeight;
            
        } catch (error) {
            console.error('Error fetching logs:', error);
            logsContent.textContent = `Error: ${error.message}`;
        }
    }
});
</script>
{% endblock %}
