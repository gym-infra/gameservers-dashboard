{% extends "base.html" %}

{% block title %}{{ game_name }} - Game Server Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Games</a></li>
                <li class="breadcrumb-item active">{{ game_name }}</li>
            </ol>
        </nav>
        <h1>{{ game_name }}</h1>
        <p class="lead">Game server instances and components</p>
    </div>
</div>

<style>
/* Golden ratio-based CSS: Using the golden ratio (1.618) for proportions */
:root {
  --golden-ratio: 1.618;
  --golden-small: calc(1rem / var(--golden-ratio));
  --golden-large: calc(1rem * var(--golden-ratio));
  --primary-color: #3498db;
  --primary-dark: #2980b9;
  --success-color: #2ecc71;
  --danger-color: #e74c3c;
  --warning-color: #f39c12;
  --secondary-color: #7f8c8d;
  --light-color: #ecf0f1;
  --dark-color: #2c3e50;
  --card-radius: 8px;
}

/* Compact grid system */
.golden-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
  gap: 1rem;
  margin-bottom: 1rem;
}

/* Responsive breakpoints */
@media (max-width: 1200px) {
  .golden-grid {
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  }
}

@media (max-width: 768px) {
  .golden-grid {
    grid-template-columns: 1fr;
  }
}

.instance-card {
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  border-radius: var(--card-radius);
  overflow: hidden;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  background-color: white;
  border: 1px solid #dee2e6;
  height: 100%;
}

.instance-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
}

.instance-header {
  background-color: var(--dark-color);
  color: white;
  padding: calc(var(--golden-small) * 2) var(--golden-large);
  font-weight: bold;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.components-grid {
  display: grid;
  /* Even more compact grid with smaller cards */
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 0.4rem;
  padding: 0.4rem;
}

@media (max-width: 992px) {
  .components-grid {
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  }
}

@media (max-width: 576px) {
  .components-grid {
    grid-template-columns: 1fr;
  }
}

.component-card {
  border: 1px solid #dee2e6;
  border-radius: var(--card-radius);
  transition: all 0.2s ease;
  height: 100%;
  display: flex;
  flex-direction: column;
  background-color: white;
  overflow: hidden;
  /* More compact size */
  min-height: 180px;
}

.component-card:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  border-color: var(--primary-color);
}

.component-header {
  padding: 0.4rem 0.6rem;
  border-bottom: 1px solid #dee2e6;
  background-color: var(--light-color);
  font-weight: 500;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.component-title {
  display: flex;
  align-items: center;
}

.component-title i {
  color: var(--primary-dark);
  margin-right: var(--golden-small);
}

.status-bubbles {
  display: flex;
  gap: 0.25rem;
}

.status-bubble {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.7rem;
  font-weight: bold;
  position: relative;
}

/* Resource bubble with hover effect */
.resource-bubble {
  cursor: pointer;
}

.resource-details {
  position: absolute;
  top: 120%;
  right: -5px;
  background-color: white;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  padding: 0.5rem;
  width: 140px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
  z-index: 10;
  color: #333;
  text-align: left;
  font-weight: normal;
  opacity: 0;
  transform: translateY(-10px);
  transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
  visibility: hidden;
  pointer-events: none;
}

.resource-bubble:hover .resource-details {
  opacity: 1;
  transform: translateY(0);
  visibility: visible;
  pointer-events: auto;
}

.resource-detail {
  padding: 3px 0;
  display: flex;
  align-items: center;
  font-size: 0.8rem;
}

.resource-detail i {
  margin-right: 0.5rem;
  color: var(--primary-color);
}

.log-container {
  flex-grow: 1;
  background-color: #1e1e1e;
  color: #f0f0f0;
  border-radius: 4px;
  margin-bottom: 0.5rem;
  overflow: hidden;
  cursor: pointer;
  transition: all 0.2s ease;
}

.log-container:hover {
  box-shadow: 0 0 0 2px var(--primary-color);
}

.component-log {
  margin: 0;
  padding: 0.5rem;
  overflow: auto;
  max-height: 100%;
  min-height: 80px;
  font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
}

/* Font size for log containers */
.component-log {
  /* Default size for multi-component servers */
  font-size: 0.65rem;
}

/* Single component gets slightly larger font */
.single-component .component-log {
  font-size: 0.7rem;
}

.component-body {
  padding: var(--golden-small);
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.component-footer {
  padding: calc(var(--golden-small)/2) var(--golden-small);
  background-color: var(--light-color);
  border-top: 1px solid #dee2e6;
  display: flex;
  justify-content: center;
}

.resource-badge {
  display: inline-flex;
  align-items: center;
  padding: calc(var(--golden-small)/2) var(--golden-small);
  margin-right: var(--golden-small);
  margin-bottom: var(--golden-small);
  border-radius: 30px;
  background-color: var(--light-color);
  font-size: 0.85rem;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.resource-badge i {
  margin-right: 0.25rem;
  color: var(--dark-color);
}

.status-indicator {
  display: flex;
  align-items: center;
  margin-bottom: 0.25rem;
  font-size: 0.85rem;
}

.status-indicator .badge {
  margin-left: auto;
  padding: calc(var(--golden-small)/2) var(--golden-small);
}

.component-detail {
  margin-bottom: var(--golden-small);
  display: flex;
  justify-content: space-between;
  font-size: 0.9rem;
}

.component-detail-label {
  color: #6c757d;
}

.component-detail-value {
  font-weight: 500;
}

.resource-container {
  display: flex;
  flex-wrap: wrap;
  margin-top: auto;
  padding-top: var(--golden-small);
  justify-content: center;
}

.btn-group .btn {
  margin: 0 1px;
}

/* Special handling for instances with a single component */
.single-component {
  grid-template-columns: 1fr !important;
}

.single-component .component-card {
  max-width: 100%;
  width: 100%;
}

/* Styling for modal logs */
.logs-container {
  max-height: 60vh;
  overflow-y: auto;
  background-color: #1e1e1e;
  border-radius: 4px;
}

.logs {
  margin: 0;
  padding: 0.5rem;
  overflow: auto;
  font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
  font-size: 0.75rem;
  color: #f0f0f0;
  white-space: pre-wrap;
}
</style>

{% if instances %}
<div class="golden-grid">
  {% for instance in instances %}
  <div class="instance-card">
    <div class="instance-header">
      <div class="d-flex align-items-center">
        <i class="bi bi-hdd-rack me-2"></i>
        <span>{{ instance.name }}</span>
      </div>
      <div>
        <button class="btn btn-sm btn-danger restart-instance" 
                title="Restart all components"
                data-instance-name="{{ instance.name }}"
                data-game-name="{{ game_name }}">
          <i class="bi bi-arrow-repeat"></i> Restart All
        </button>
      </div>
    </div>
    <div class="components-grid {% if instance.components|length == 1 %}single-component{% endif %}">
      {% for component in instance.components %}
      <div class="component-card">
        <div class="component-header">
          <div class="component-title">
            <i class="bi bi-puzzle"></i>
            <span class="ms-2">{{ component.component }}</span>
          </div>
          <div class="status-bubbles">
            <!-- Resources bubble with hover effect -->
            <span class="status-bubble resource-bubble bg-info" title="Resources">
              <i class="bi bi-activity"></i>
              <div class="resource-details">
                <div class="resource-detail">
                  <i class="bi bi-cpu"></i> {{ component.cpu_usage or 'N/A' }}
                </div>
                <div class="resource-detail">
                  <i class="bi bi-memory"></i> {{ component.memory_usage or 'N/A' }}
                </div>
              </div>
            </span>
            
            <!-- Status bubble -->
            {% if component.status == "active" %}
            <span class="status-bubble bg-success" title="Status: Active"><i class="bi bi-check-circle-fill"></i></span>
            {% else %}
            <span class="status-bubble bg-danger" title="Status: Failed"><i class="bi bi-x-circle-fill"></i></span>
            {% endif %}
            
            <!-- Replicas bubble -->
            {% if component.replicas > 0 and component.available_replicas == 0 %}
            <span class="status-bubble bg-danger" title="Replicas: {{ component.available_replicas or 0 }}/{{ component.replicas }}">{{ component.available_replicas or 0 }}/{{ component.replicas }}</span>
            {% elif component.replicas > 0 and component.available_replicas < component.replicas %}
            <span class="status-bubble bg-warning" title="Replicas: {{ component.available_replicas or 0 }}/{{ component.replicas }}">{{ component.available_replicas or 0 }}/{{ component.replicas }}</span>
            {% elif component.replicas == 0 %}
            <span class="status-bubble bg-secondary" title="Replicas: Stopped">0</span>
            {% else %}
            <span class="status-bubble bg-success" title="Replicas: Ready">{{ component.available_replicas or 0 }}</span>
            {% endif %}
          </div>
        </div>
        <div class="component-body">
          <div class="log-container" 
               data-namespace="{{ component.namespace }}" 
               data-name="{{ component.name }}"
               data-bs-toggle="modal"
               data-bs-target="#logsModal"
               title="Click to view full logs">
            <pre class="component-log">Loading logs...</pre>
          </div>
        </div>
        <div class="component-footer">
          <div class="btn-group" role="group">
            <button class="btn btn-sm btn-success start-deployment" 
                    data-namespace="{{ component.namespace }}" 
                    data-name="{{ component.name }}"
                    title="Start"
                    {% if component.replicas > 0 %}disabled{% endif %}>
                <i class="bi bi-play-fill"></i>
            </button>
            <button class="btn btn-sm btn-primary restart-deployment" 
                    data-namespace="{{ component.namespace }}" 
                    data-name="{{ component.name }}"
                    title="Restart"
                    {% if component.replicas == 0 %}disabled{% endif %}>
                <i class="bi bi-arrow-clockwise"></i>
            </button>
            <button class="btn btn-sm btn-danger stop-deployment" 
                    data-namespace="{{ component.namespace }}" 
                    data-name="{{ component.name }}"
                    title="Stop"
                    {% if component.replicas == 0 %}disabled{% endif %}>
                <i class="bi bi-stop-fill"></i>
            </button>
            <button class="btn btn-sm btn-secondary view-logs" 
                    data-namespace="{{ component.namespace }}" 
                    data-name="{{ component.name }}"
                    data-bs-toggle="modal"
                    data-bs-target="#logsModal"
                    title="View Logs"
                    {% if component.replicas == 0 %}disabled{% endif %}>
                <i class="bi bi-terminal"></i>
            </button>
            {% if component.files_url %}
            <a href="{{ component.files_url }}" 
               class="btn btn-sm btn-info"
               target="_blank"
               title="Open Files">
                <i class="bi bi-folder"></i>
            </a>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
<div class="alert alert-info">
  <h4 class="alert-heading">No instances found for {{ game_name }}!</h4>
  <p>No deployments with game-server/game={{ game_name }} annotation were found.</p>
</div>
{% endif %}
<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel">Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage">Are you sure?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmActionButton">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Status Toast Container -->
<div class="toast-container position-fixed bottom-0 start-50 translate-middle-x p-3">
    <div id="statusToast" class="toast align-items-center text-white" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toastMessage">
                Operation completed successfully.
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<!-- Logs Modal -->
<div class="modal fade" id="logsModal" tabindex="-1" aria-labelledby="logsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logsModalLabel">Container Logs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <select id="podSelector" class="form-select">
                            <option selected>Loading pods...</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <select id="containerSelector" class="form-select" disabled>
                            <option selected>Select pod first</option>
                        </select>
                    </div>
                </div>
                <div class="logs-container">
                    <pre id="logsContent" class="logs">Loading logs...</pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="refreshLogs">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toast and confirmation helpers
    const statusToast = document.getElementById('statusToast');
    const toastMessage = document.getElementById('toastMessage');
    const confirmationModal = document.getElementById('confirmationModal');
    const confirmationMessage = document.getElementById('confirmationMessage');
    const confirmActionButton = document.getElementById('confirmActionButton');
    const bsConfirmModal = new bootstrap.Modal(confirmationModal);
    
    // CSS for toast variants
    const toastClasses = {
        success: 'bg-success',
        error: 'bg-danger',
        warning: 'bg-warning',
        info: 'bg-info'
    };
    
    // Helper to show confirmation modal
    function showConfirmation(message, onConfirm, btnRef = null) {
        // Set message
        confirmationMessage.textContent = message;
        
        // Store the current click handler function to be used in the onclick event
        confirmActionButton.onclick = function() {
            bsConfirmModal.hide();
            onConfirm();
        };
        
        // Show the modal
        bsConfirmModal.show();
    }
    
    // Helper to show status toast
    function showToast(message, type = 'success', duration = 3000) {
        // Remove all toast variant classes
        for (const className of Object.values(toastClasses)) {
            statusToast.classList.remove(className);
        }
        
        // Add the appropriate class
        statusToast.classList.add(toastClasses[type]);
        
        // Set message
        toastMessage.textContent = message;
        
        // Show toast
        const bsToast = new bootstrap.Toast(statusToast, { delay: duration });
        bsToast.show();
    }
    
    // Automatically fetch and update logs for all components
    const componentLogs = document.querySelectorAll('.log-container');
    
    // Function to get the last 8 lines of log text
    function getLastLines(text, numLines) {
        const lines = text.split('\n');
        return lines.slice(-numLines).join('\n');
    }
    
    // Handle log container clicks to open modal
    componentLogs.forEach(logContainer => {
        // Initial log fetching for each component
        const namespace = logContainer.getAttribute('data-namespace');
        const name = logContainer.getAttribute('data-name');
        const logDisplay = logContainer.querySelector('.component-log');
        
        // Function to fetch logs for a specific component
        async function fetchComponentLogs(isRefresh = false) {
            try {
                // First get pods for this deployment
                const podsResponse = await fetch(`/api/deployments/${namespace}/${name}/pods`);
                
                if (!podsResponse.ok) {
                    if (!isRefresh) logDisplay.textContent = 'No pods found';
                    return;
                }
                
                const pods = await podsResponse.json();
                
                if (pods.length === 0) {
                    if (!isRefresh) logDisplay.textContent = 'No pods found';
                    return;
                }
                
                // Get first pod's logs - let backend handle container selection
                const podName = pods[0].name;
                const logUrl = `/api/pods/${namespace}/${podName}/logs?tail_lines=10`;
                const logsResponse = await fetch(logUrl);
                
                if (!logsResponse.ok) {
                    if (!isRefresh) logDisplay.textContent = 'Error loading logs';
                    return;
                }
                
                const data = await logsResponse.json();
                
                if (data.logs && data.logs.trim()) {
                    // Show only the last 8 lines
                    logDisplay.textContent = getLastLines(data.logs, 8);
                } else {
                    if (!isRefresh) logDisplay.textContent = 'No logs available';
                }
            } catch (error) {
                console.error(`Error fetching logs for ${namespace}/${name}:`, error);
                if (!isRefresh) logDisplay.textContent = 'Error loading logs';
            }
        }
        
        // Fetch logs immediately
        fetchComponentLogs();
        
        // Set up auto-refresh every minute (pass isRefresh=true to avoid showing loading message)
        const refreshInterval = setInterval(() => fetchComponentLogs(true), 60000);
        
        // Clean up interval if the element is removed from DOM
        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                mutation.removedNodes.forEach(node => {
                    if (node === logContainer || node.contains(logContainer)) {
                        clearInterval(refreshInterval);
                        observer.disconnect();
                    }
                });
            });
        });
        
        observer.observe(document.body, { childList: true, subtree: true });
        
        // Open logs modal when clicking on the log container
        logContainer.addEventListener('click', function() {
            currentNamespace = namespace;
            currentDeployment = name;
            
            // Update modal title
            document.getElementById('logsModalLabel').textContent = 
                `Logs: ${name} (${namespace})`;
            
            // Reset pod selector and logs content
            podSelector.innerHTML = '<option selected>Loading pods...</option>';
            logsContent.textContent = 'Loading pods...';
            
            // Fetch pods for this deployment
            fetchPods(namespace, name);
        });
    });

    // Handle start buttons
    document.querySelectorAll('.start-deployment').forEach(button => {
        button.addEventListener('click', function() {
            const namespace = this.getAttribute('data-namespace');
            const name = this.getAttribute('data-name');
            const btnRef = this;
            
            // Show confirmation modal with button reference
            showConfirmation(`Are you sure you want to start the deployment ${namespace}/${name}?`, async function() {
                // Button was confirmed, proceed with the action
                const originalContent = btnRef.innerHTML;
                btnRef.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
                
                try {
                    const response = await fetch(`/api/deployments/${namespace}/${name}/start`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        showToast('Deployment start initiated successfully!', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        showToast(`Error: ${result.detail || 'Unknown error'}`, 'error');
                        btnRef.innerHTML = originalContent;
                    }
                } catch (error) {
                    showToast(`Failed to start deployment: ${error.message}`, 'error');
                    btnRef.innerHTML = originalContent;
                }
            });
        });
    });

    // Handle restart buttons
    document.querySelectorAll('.restart-deployment').forEach(button => {
        button.addEventListener('click', function() {
            const namespace = this.getAttribute('data-namespace');
            const name = this.getAttribute('data-name');
            const btnRef = this;
            
            // Show confirmation modal with button reference
            showConfirmation(`Are you sure you want to restart the deployment ${namespace}/${name}?`, async function() {
                // Button was confirmed, proceed with the action
                const originalContent = btnRef.innerHTML;
                btnRef.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
                
                try {
                    const response = await fetch(`/api/deployments/${namespace}/${name}/restart`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        showToast('Deployment restart initiated successfully!', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        showToast(`Error: ${result.detail || 'Unknown error'}`, 'error');
                        btnRef.innerHTML = originalContent;
                    }
                } catch (error) {
                    showToast(`Failed to restart deployment: ${error.message}`, 'error');
                    btnRef.innerHTML = originalContent;
                }
            });
        });
    });

    // Handle restart instance (all components) buttons
    document.querySelectorAll('.restart-instance').forEach(button => {
        button.addEventListener('click', function() {
            const instanceName = this.getAttribute('data-instance-name');
            const gameName = this.getAttribute('data-game-name');
            const btnRef = this;
            
            // Show confirmation modal with button reference
            showConfirmation(`Are you sure you want to restart ALL components in the instance "${instanceName}"?`, async function() {
                // Find all component buttons in this instance
                const componentButtons = document.querySelectorAll(`.component-card .restart-deployment`);
                let componentsToRestart = [];
                
                componentButtons.forEach(componentBtn => {
                    const namespace = componentBtn.getAttribute('data-namespace');
                    const name = componentBtn.getAttribute('data-name');
                    
                    // For debugging: log all components being considered
                    console.log(`Checking component ${name} for instance ${instanceName}`);
                    
                    // Look for the component card's parent instance
                    const componentCard = componentBtn.closest('.component-card');
                    const instanceHeader = componentBtn.closest('.instance-card').querySelector('.instance-header');
                    const instanceTitleSpan = instanceHeader.querySelector('span');
                    const cardInstanceName = instanceTitleSpan.textContent.trim();
                    
                    console.log(`Component ${name} belongs to instance: "${cardInstanceName}"`);
                    
                    // Match based on DOM structure rather than name substring
                    if (cardInstanceName === instanceName) {
                        componentsToRestart.push({ namespace, name, button: componentBtn });
                    }
                });
                
                if (componentsToRestart.length === 0) {
                    showToast('No components found to restart.', 'warning');
                    return;
                }
                
                // Show loading indicator on the main restart button
                const originalContent = btnRef.innerHTML;
                btnRef.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Restarting...';
                
                // Restart each component sequentially
                let allSuccess = true;
                let restartedCount = 0;
                
                for (const component of componentsToRestart) {
                    try {
                        const response = await fetch(`/api/deployments/${component.namespace}/${component.name}/restart`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            restartedCount++;
                        } else {
                            console.error(`Failed to restart ${component.name}: ${result.detail || 'Unknown error'}`);
                            allSuccess = false;
                        }
                    } catch (error) {
                        console.error(`Error restarting ${component.name}: ${error.message}`);
                        allSuccess = false;
                    }
                }
                
                if (allSuccess) {
                    showToast(`All ${restartedCount} components in instance "${instanceName}" are being restarted!`, 'success');
                } else {
                    showToast(`Some components could not be restarted. ${restartedCount} of ${componentsToRestart.length} were successful.`, 'warning');
                }
                
                // Reload the page after a short delay
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            });
        });
    });
    
    // Handle stop buttons
    document.querySelectorAll('.stop-deployment').forEach(button => {
        button.addEventListener('click', function() {
            const namespace = this.getAttribute('data-namespace');
            const name = this.getAttribute('data-name');
            const btnRef = this;
            
            // Show confirmation modal with button reference
            showConfirmation(`Are you sure you want to stop the deployment ${namespace}/${name}?`, async function() {
                // Button was confirmed, proceed with the action
                const originalContent = btnRef.innerHTML;
                btnRef.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
                
                try {
                    const response = await fetch(`/api/deployments/${namespace}/${name}/stop`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        showToast('Deployment stop initiated successfully!', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        showToast(`Error: ${result.detail || 'Unknown error'}`, 'error');
                        btnRef.innerHTML = originalContent;
                    }
                } catch (error) {
                    showToast(`Failed to stop deployment: ${error.message}`, 'error');
                    btnRef.innerHTML = originalContent;
                }
            });
        });
    });
    
    // Logs modal handling
    const logsModal = document.getElementById('logsModal');
    const podSelector = document.getElementById('podSelector');
    const logsContent = document.getElementById('logsContent');
    const refreshLogsButton = document.getElementById('refreshLogs');
    
    let currentNamespace = null;
    let currentDeployment = null;
    let currentPod = null;
    let pods = []; // Store pods data for container selection
    
    // Handle view logs button clicks
    document.querySelectorAll('.view-logs').forEach(button => {
        button.addEventListener('click', function() {
            currentNamespace = this.getAttribute('data-namespace');
            currentDeployment = this.getAttribute('data-name');
            
            // Update modal title
            document.getElementById('logsModalLabel').textContent = 
                `Logs: ${currentDeployment} (${currentNamespace})`;
            
            // Reset pod selector and logs content
            podSelector.innerHTML = '<option selected>Loading pods...</option>';
            logsContent.textContent = 'Loading pods...';
            
            // Fetch pods for this deployment
            fetchPods(currentNamespace, currentDeployment);
        });
    });
    
    // Auto-refresh for modal logs
    let modalRefreshInterval = null;
    
    // Start auto-refresh when modal is shown
    logsModal.addEventListener('shown.bs.modal', function () {
        // Set up auto-refresh every 5 seconds
        modalRefreshInterval = setInterval(() => {
            if (currentNamespace && currentPod) {
                fetchLogs(currentNamespace, currentPod, true, currentContainer); // Pass isRefresh=true and container
            }
        }, 5000);
    });
    
    // Stop auto-refresh when modal is hidden
    logsModal.addEventListener('hidden.bs.modal', function () {
        if (modalRefreshInterval) {
            clearInterval(modalRefreshInterval);
            modalRefreshInterval = null;
        }
    });
    
    // Container selector reference
    const containerSelector = document.getElementById('containerSelector');
    
    // Current container selection
    let currentContainer = null;
    
    // Handle pod selection change
    podSelector.addEventListener('change', function() {
        if (this.value) {
            currentPod = this.value;
            
            // Find the selected pod to get container list
            const selectedPod = pods.find(pod => pod.name === currentPod);
            
            // Reset container selector
            containerSelector.innerHTML = '';
            containerSelector.disabled = false;
            
            if (selectedPod && selectedPod.containers && selectedPod.containers.length > 0) {
                // Add "All Containers" option for default container selection
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                
                // Just use "Default Container" without showing annotation details
                defaultOption.textContent = `Default Container`;
                
                containerSelector.appendChild(defaultOption);
                
                // Add each container to the selector
                selectedPod.containers.forEach(container => {
                    const option = document.createElement('option');
                    option.value = container.name;
                    option.textContent = container.name;
                    containerSelector.appendChild(option);
                });
                
                // Set current container to default (empty string)
                currentContainer = "";
            } else {
                // If no containers found
                containerSelector.innerHTML = '<option>No containers found</option>';
                containerSelector.disabled = true;
                currentContainer = null;
            }
            
            // Fetch logs for the selected pod with default container
            fetchLogs(currentNamespace, currentPod, false, currentContainer);
        }
    });
    
    // Handle container selection change
    containerSelector.addEventListener('change', function() {
        currentContainer = this.value;
        if (currentNamespace && currentPod) {
            fetchLogs(currentNamespace, currentPod, false, currentContainer);
        }
    });
    
    // Handle refresh logs button
    refreshLogsButton.addEventListener('click', function() {
        if (currentNamespace && currentPod) {
            fetchLogs(currentNamespace, currentPod, false, currentContainer); // Pass current container when refreshing
        }
    });
    
    // Function to fetch pods for a deployment
    async function fetchPods(namespace, deployment) {
        try {
            const response = await fetch(`/api/deployments/${namespace}/${deployment}/pods`);
            
            if (!response.ok) {
                throw new Error('Failed to fetch pods');
            }
            
            pods = await response.json(); // Store pods globally
            
            // Clear pod selector
            podSelector.innerHTML = '';
            
            if (pods.length === 0) {
                podSelector.innerHTML = '<option>No pods found</option>';
                logsContent.textContent = 'No pods found for this deployment.';
                return;
            }
            
            // Add pods to selector
            pods.forEach(pod => {
                const option = document.createElement('option');
                option.value = pod.name;
                option.textContent = `${pod.name} (${pod.status})`;
                podSelector.appendChild(option);
            });
            
            // Select the first pod, populate container dropdown, and fetch logs
            currentPod = pods[0].name;
            
            // Find the selected pod to get container list
            const selectedPod = pods.find(pod => pod.name === currentPod);
            
            // Reset container selector
            containerSelector.innerHTML = '';
            containerSelector.disabled = false;
            
            if (selectedPod && selectedPod.containers && selectedPod.containers.length > 0) {
                // Add "Default Container" option
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = `Default Container`;
                containerSelector.appendChild(defaultOption);
                
                // Add each container to the selector
                selectedPod.containers.forEach(container => {
                    const option = document.createElement('option');
                    option.value = container.name;
                    option.textContent = container.name;
                    containerSelector.appendChild(option);
                });
                
                // Set current container to default (empty string)
                currentContainer = "";
            } else {
                // If no containers found
                containerSelector.innerHTML = '<option>No containers found</option>';
                containerSelector.disabled = true;
                currentContainer = null;
            }
            
            // Fetch logs
            fetchLogs(namespace, currentPod, false, currentContainer);
            
        } catch (error) {
            console.error('Error fetching pods:', error);
            podSelector.innerHTML = '<option>Failed to load pods</option>';
            logsContent.textContent = `Error: ${error.message}`;
        }
    }
    
    // Function to fetch logs for a pod
    async function fetchLogs(namespace, podName, isRefresh = false, container = null) {
        // Only show loading indicator on first load, not on refresh
        if (!isRefresh) {
            logsContent.textContent = 'Loading logs...';
        }
        
        try {
            // Build the URL with container parameter if specified
            let logUrl = `/api/pods/${namespace}/${podName}/logs?tail_lines=200`;
            if (container) {
                logUrl += `&container=${encodeURIComponent(container)}`;
            }
            const response = await fetch(logUrl);
            
            if (!response.ok) {
                throw new Error('Failed to fetch logs');
            }
            
            const data = await response.json();
            
            // Display logs
            if (data.logs && data.logs.trim()) {
                logsContent.textContent = data.logs;
            } else {
                logsContent.textContent = 'No logs available.';
            }
            
            // Scroll to bottom of logs
            const logsContainer = document.querySelector('.logs-container');
            logsContainer.scrollTop = logsContainer.scrollHeight;
            
        } catch (error) {
            console.error('Error fetching logs:', error);
            if (!isRefresh) {
                logsContent.textContent = `Error: ${error.message}`;
            }
        }
    }
});
</script>
{% endblock %}
